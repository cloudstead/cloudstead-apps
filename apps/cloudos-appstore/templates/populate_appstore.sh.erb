#!/bin/bash
#
# Called during chef-run, populates the appstore with the initial set of apps
#

if [ -z "${APPSTORE_PASS}" ] ; then
  echo "No APPSTORE_PASS found in environment"
  exit 1
fi

ADMIN="<%=@app[:databag][:init]['admin']['name']%>"
SERVER="http://127.0.0.1:<%=@app[:databag][:ports]['primary']%>"

OK_APPS=""
SKIPPED_APPS=""
FAILED_APPS=""

function populate_app {
  app_name="${1}"
  status="${2}"
  bundle_url="${3}"
  bundle_sha="${4}"

  if cas apps --account ${ADMIN} --server ${SERVER} --operation read --name ${app_name} ; then
    SKIPPED_APPS="${SKIPPED_APPS} ${app_name}"
  else
    if ! publish_app.sh ${ADMIN} ${status} ${bundle_url} ${bundle_sha} ${SERVER} ; then
      OK_APPS="${OK_APPS} ${app_name}"
    else
      FAILED_APPS="${FAILED_APPS} ${app_name}"
    fi
  fi
}

<% %w(created pending published hidden retired).each do |status| %>

  <% if @app[:databag][:apps].has_key? status %>
    <% @app[:databag][:apps][status].each do |app| %>
populate_app <%=app['name']%> <%=status%> <%=app['bundle_url']%> <%=app['bundle_sha']%>
    <% end %>
  <% end %>

<% end %>

echo "---------------------------------"
echo "Appstore initialization complete"
echo "Apps installed OK: ${OK_APPS}"
echo "Apps already installed (skipped): ${SKIPPED_APPS}"
echo "Apps that FAILED installation: ${FAILED_APPS}"
echo "---------------------------------"
