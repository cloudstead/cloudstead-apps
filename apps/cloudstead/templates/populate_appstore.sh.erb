#!/bin/bash
#
# Called during chef-run, populates the appstore with the initial set of apps
#

function die {
  echo >&2 "${1}" ; exit 1
}

if [ -z "${APPSTORE_PASS}" ] ; then die "No APPSTORE_PASS found in environment" ; fi

ADMIN="<%=@app[:databag][:init]['appstore']['cloudstead']['user']%>"
SERVER="<%=@app[:lib].subst_string(@app[:databag][:init]['appstore']['base_uri'], @app)%>"

FORCE="${1}"

OK_APPS=""
SKIPPED_APPS=""
FAILED_APPS=""

function populate_app {
  publisher="${1}"
  app_name="${2}"
  visibility="${3}"
  bundle_url="${4}"
  bundle_sha="${5}"

  if cas apps --account ${ADMIN} --publisher ${publisher} --server ${SERVER} --operation read --name ${app_name} && [ "${FORCE}" != "--force" ] ; then
    SKIPPED_APPS="${SKIPPED_APPS} ${publisher}/${app_name}"
  else
    if publish_app.sh ${ADMIN} ${publisher} ${visibility} ${bundle_url} ${bundle_sha} ${SERVER} ; then
      OK_APPS="${OK_APPS} ${publisher}/${app_name}"
    else
      FAILED_APPS="${FAILED_APPS} ${publisher}/${app_name}"
    fi
  fi
}

  <% if %w(public cloudstead).each do |publisher| %>
    <% @app[:databag][:apps][publisher].each do |app| %>
populate_app <%=publisher%> <%=app['name']%> <%=app['visibility']%> <%=app['bundle_url']%> <%=app['bundle_sha']%>
    <% end %>
  <% end %>

<% end %>

echo "---------------------------------"
echo "Appstore initialization complete"
echo "Apps installed OK: ${OK_APPS}"
echo "Apps already installed (skipped): ${SKIPPED_APPS}"
echo "Apps that FAILED installation: ${FAILED_APPS}"
echo "---------------------------------"
