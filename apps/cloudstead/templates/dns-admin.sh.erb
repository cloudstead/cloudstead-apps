#!/bin/bash

BASE=$(cd <%=@app[:run_as_home]%>/<%=@app[:name]%> && pwd)

JAR_PATTERN="cloudstead-server-*.jar"
JAR_DIR="${BASE}/target"

JAR="$(find ${JAR_DIR} -maxdepth 1 -type f -name ${JAR_PATTERN})"
NUM_JARS=$(find ${JAR_DIR} -maxdepth 1 -type f -name ${JAR_PATTERN} | wc -l | tr -d ' ')

if [ ${NUM_JARS} -eq 0 ] ; then
    echo 1>&2 "No cloudstead-server jar found in ${JAR_DIR}. Please build it first: cd ${BASE}/target && mvn package"
    exit 1

elif [ ${NUM_JARS} -gt 1 ] ; then
    echo 1>&2 "Multiple cloudstead-server jars found in ${JAR_DIR}: ${JAR}"
    exit 1
fi

CONFIG=<%=@app[:chef_user_home]%>/chef/data_bags/cloudos-dns/init.json
CONFIG_NODE="dyndns"

cd ${BASE}

java -cp ${JAR} cloudos.dns.main.DnsMain --config ${CONFIG} --config-node ${CONFIG_NODE} "$@"
